<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Introdução a Web Scraping com R</title>
    <meta charset="utf-8" />
    <meta name="author" content="Jodavid Ferreira" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link rel="stylesheet" href="css/jodavid.css" type="text/css" />
    <link rel="stylesheet" href="css/mmp.css" type="text/css" />
    <link rel="stylesheet" href="css/mmp-fonts.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Introdução a Web Scraping com R
### Jodavid Ferreira
### 31.jan.2021

---

layout: true

&lt;div class="my-footer"&gt;&lt;span&gt;

&lt;a href="http://jodavid.github.io"&gt;Jodavid Ferreira&lt;/a&gt; - email: &lt;a href="mailto:jdaf1@de.ufpe.br"&gt;jdaf1@de.ufpe.br&lt;/a&gt;
&lt;/span&gt;&lt;/div&gt;


---





&lt;br/&gt;
# O que é Web Scrapping?

&lt;br/&gt;
* O **Web Scraping** é uma área da **Text Mining**;


&lt;br/&gt;&lt;br/&gt;
### O que é Text Mining?

&lt;br/&gt;
*  Text Mining ou Mineração de texto é o processo de **destilar**&lt;sup&gt;1&lt;/sup&gt; **insights** do texto.


.footnote[
[1] A destilação é uma técnica de separação.
]

---

### Onde a mineração de texto se encaixa?

&lt;br/&gt;
* Para acadêmicos, pode auxiliar na compreensão de transcrições qualitativas ou num estudo da linguagem;

&lt;br/&gt;
* Para empresas, pode render informações interessantes que auxiliarão na modelagem preditiva por exemplo;

&lt;br/&gt;
* Aos profissionais de marketing, podem auxiliar na criação de textos, fornecendo recomendações precisas para sua organização.
&lt;!--isso porque através de análises de textos externos, eles podem criar os seus fornecendo recomendações precisas para sua organização.--&gt;

&lt;br/&gt;
* Então, a mineração de texto pode ser usada em qualquer decisão baseada em dados, onde o texto se encaixa naturalmente como uma entrada.


---

# Pacote `rvest`

&lt;br/&gt;
&lt;br/&gt;

&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="https://raw.githubusercontent.com/tidyverse/rvest/master/man/figures/logo.png" alt="&amp;lt;center&amp;gt;&amp;lt;b&amp;gt;Logo - rvest &amp;lt;/center&amp;gt;&amp;lt;/b&amp;gt;" width="20%" /&gt;
&lt;p class="caption"&gt;&lt;center&gt;&lt;b&gt;Logo - rvest &lt;/center&gt;&lt;/b&gt;&lt;/p&gt;
&lt;/div&gt;

&lt;br/&gt;


`rvest` ajuda você a extrair (ou colher) dados de páginas da web.

Ele foi projetado para funcionar com *magrittr* (pacote responsável pelo operador pipe *%&gt;%*) para facilitar a expressão de tarefas comuns de web scraping, inspiradas em bibliotecas como a `beautiful soup` e `RoboBrowser`.

&lt;!--
Se você estiver copiando várias páginas, recomendo fortemente o uso de rvest em conjunto com educado. O pacote educado garante que você respeite o robots.txt e não martele o site com muitas solicitações.
--&gt;

---

# O que é HTML e CSS ?

* **HTML** (HyperText Markup Language - Linguagem de Marcação de Hipertexto) - é uma linguagem de marcação usada para estruturar uma página web.

* **CSS** (Cascading Style Sheets - Folha de Estilo em Cascata) - é usado para estilizar os elementos escritos no *HTML*.



### O que precisa saber ?

Em **HTML** e **CSS**, existe a possibilidade de aplicar estilos através de 'class' e 'id';



* **HTML** : 
 * *class* : é o atributo global formado por uma lista das classes de um elemento, separada por espaços.
&lt;!-- Classes permitem a CSS e Javascript selecionar e acessar elementos específicos através dos seletores de classe ou funções como o método DOM. --&gt;
  * *id* : define um identificador exclusivo (ID) que deve ser único por todo o documento.
&lt;!--Seu objetivo é identificar o elemento ao navegar por âncoras (usando um identificador de fragmento), quando utilizar scripts ou estilizando (com CSS).--&gt;

* **CSS**: usado para personalizar a parte visual dos sites.

---

# Instalando o `rvest`

&lt;br/&gt;
Instalando o `rvest` através do `devtools`

&lt;br/&gt;

```r
install.packages("devtools")
library(devtools)
devtools::install_github("tidyverse/rvest")
```

&lt;br/&gt;
&lt;br/&gt;
Lendo o pacote:

&lt;br/&gt;

```r
library(rvest)
```

---

## Exemplo 1: Extraindo informações site Jarbas

### Projeto Serenata de Amor

O estudo será realizado sobre o projeto “SERENATA DE AMOR” [https://serenata.ai/](https://serenata.ai/), que é um projeto aberto no qual usa data science (ciência de dados) - a mesma tecnolgia usada por gigantes como Google, Facebook e Netflix - com o objetivo de monitorar os gastos públicos e compartilhar informações de forma acessível a todos.


* Jarbas - [https://jarbas.serenata.ai/dashboard/chamber_of_deputies/reimbursement/](https://jarbas.serenata.ai/dashboard/chamber_of_deputies/reimbursement/)


&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="imagens/jarbas.png" alt="&amp;lt;center&amp;gt;&amp;lt;b&amp;gt;site Jarbas &amp;lt;/center&amp;gt;&amp;lt;/b&amp;gt;" width="100%" /&gt;
&lt;p class="caption"&gt;&lt;center&gt;&lt;b&gt;site Jarbas &lt;/center&gt;&lt;/b&gt;&lt;/p&gt;
&lt;/div&gt;



---

## Exemplo 1: Extraindo informações site Jarbas

### Passo 1: Lendo a URL

Usando a função `read_html` do pacote `xml2` (este pacote é uma dependência do `rvest`) para ler a url.


```r
library(rvest)

url &lt;- "https://jarbas.serenata.ai/dashboard/chamber_of_deputies/reimbursement/"
jarbas_webpage &lt;- read_html(url)
```

---


## Exemplo 1: Extraindo informações site Jarbas

### Passo 2: Extrair dados de classes do CSS

Class: *.field-congressperson_name*

&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="imagens/field-congresso-name.png" alt="&amp;lt;center&amp;gt;&amp;lt;b&amp;gt;class:  .field-congressperson_name &amp;lt;/center&amp;gt;&amp;lt;/b&amp;gt;" width="100%" /&gt;
&lt;p class="caption"&gt;&lt;center&gt;&lt;b&gt;class:  .field-congressperson_name &lt;/center&gt;&lt;/b&gt;&lt;/p&gt;
&lt;/div&gt;

---


## Exemplo 1: Extraindo informações site Jarbas

### Passo 2:


Duas funções serão utilizadas aqui:

1. *html_nodes*: Use esta função para extrair os nós que desejamos (neste caso nós com ".field-congressperson_name" como classe css)
2. *html_text*: Use esta função para extrair o texto entre dos nós html (neste caso, os nomes de nossos representantes)


```r
#Scraping  usando classe css ‘field-congressperson_name’
jarbas_names_html &lt;-html_nodes(jarbas_webpage, '.field-congressperson_name')
jarbas_names &lt;- html_text(jarbas_names_html)
head(jarbas_names,3)
```

```
## [1] "Valmir Assunção" "Hélio Leite"     "Hélio Leite"
```

---

## Exemplo 1: Extraindo informações site Jarbas

### Passo 2:



```r
#SUBQUOTA TRANSLATED
jarbas_subquota_html &lt;-html_nodes(jarbas_webpage, '.field-subquota_translated')
jarbas_subquota &lt;- html_text(jarbas_subquota_html)
head(jarbas_subquota,3)
```

```
## [1] "Combustíveis e lubrificantes"        "Divulgação da atividade parlamentar" "Divulgação da atividade parlamentar"
```

```r
#Fornecedor
jarbas_provider_html &lt;-html_nodes(jarbas_webpage, '.field-supplier_info')
jarbas_provider &lt;- html_text(jarbas_provider_html)
head(jarbas_provider,3)
```

```
## [1] "POSTO MK 107 NORTE LTDA05.625.571/0001-35"                         "PRISCILLA DE CASSIA PORTELA VINHOTE 7054665724934.314.072/0001-25" "M SANTOS GUIMARAES EIRELI23.936.281/0001-94"
```

```r
#Valores em Real
jarbas_value_html &lt;-html_nodes(jarbas_webpage, '.field-value')
jarbas_value &lt;- html_text(jarbas_value_html)
head(jarbas_value,3)
```

```
## [1] "R$ 198,84" "R$ 900,00" "R$ 300,00"
```

---

## Exemplo 1: Extraindo informações site Jarbas

### Passo 2:

A seguir serão mostrados o valor do reembolso, eles são extraídos
em tipo de variável caracter: Ex: R\$ 139,76, R\$ 40,23.
Entretanto, como desejamos manipular esses números, precisamos convertê-los para tipo de variável numérica, dessa forma será utilizado a biblioteca: "*stringr*" mais especificamente a função: `str_extract`. Segue o script para conversão da variável.


```r
library(stringr)
#Conversão para tipo numérico
jarbas_value &lt;- as.numeric(sub(",",".",
                str_extract(jarbas_value,pattern = "\\-*\\d+,\\s{0,}\\d+")))
head(jarbas_value,3)
```

```
## [1] 198.84 900.00 300.00
```

---

## Exemplo 1: Extraindo informações site Jarbas

### Passo 3: Geração de data.frame


```r
#Combinando todas as características obtidas
jarbas_names &lt;- str_extract(jarbas_names,pattern = boundary("word"))
jarbas_df &lt;- data.frame(
  Name = jarbas_names,
  Subquota = jarbas_subquota,
  Provider = jarbas_provider,
  Value = jarbas_value
  )

#Mostrando tipo das variáveis
str(jarbas_df)
```

```
## 'data.frame':	100 obs. of  4 variables:
##  $ Name    : chr  "Valmir" "Hélio" "Hélio" "Hélio" ...
##  $ Subquota: chr  "Combustíveis e lubrificantes" "Divulgação da atividade parlamentar" "Divulgação da atividade parlamentar" "Combustíveis e lubrificantes" ...
##  $ Provider: chr  "POSTO MK 107 NORTE LTDA05.625.571/0001-35" "PRISCILLA DE CASSIA PORTELA VINHOTE 7054665724934.314.072/0001-25" "M SANTOS GUIMARAES EIRELI23.936.281/0001-94" "SUPER POSTO PALMEIRA LTDA83.838.839/0001-20" ...
##  $ Value   : num  199 900 300 5022 13000 ...
```

---

## Exemplo 1: Extraindo informações site Jarbas

### Passo 4: Geração de um gráfico

Foram utilizados as 50 primeiras linhas do data.frame e uma biblioteca *ggplot2* para geração do gráfico.


```r
library(ggplot2)

jarbas_df &lt;- jarbas_df[1:50,]

ggplot(
  jarbas_df, aes(Value,Name,colour=Subquota)) +
  geom_point() +
  labs(title="", x ="pedidos de reembolso (R$)",
       y = "deputados",colour="SUBQUOTA TRANSLATED")
```


---

&lt;img src="index_files/figure-html/unnamed-chunk-12-1.png" style="display: block; margin: auto;" /&gt;

---

## Exemplo 2: ???


# Fontes

* Slide produzido com Rmarkdown, com template
`Xaringan`: [https://github.com/yihui/xaringan](https://github.com/yihui/xaringan).
* Livro: `Text Mining in Practice with R`;

* [https://github.com/tidyverse/rvest](https://github.com/tidyverse/rvest)
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
